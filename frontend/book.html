<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“˜ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©ØªØ§Ø¨</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      direction: rtl;
      font-family: "Vazirmatn";
      background: #f4f7fb;
      margin: 0;
      padding: 0;
    }

    #pendingBox {
      display: none;
      background: #fff3cd;
      color: #7f6500;
      border: 1px solid #ffeeba;
      padding: 12px;
      margin: 15px auto;
      width: 92%;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 15px;
    }

    .book-container {
      width: 92%;
      margin: 25px auto 50px auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .book-box {
      display: flex;
      gap: 35px;
      padding: 10px 0;
      flex-wrap: wrap;
    }

    .book-img {
      width: 230px;
      height: 300px;
      border-radius: 10px;
      background: #eee;
      object-fit: cover;
    }

    .book-info p {
      margin: 6px 0;
      font-size: 16px;
    }

    .btn-primary {
      background: #1f3c88;
      color: white;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      margin-top: 12px;
      font-size: 15px;
    }

    .btn-primary.disabled {
      background: #999;
      cursor: not-allowed;
    }

    .related-books {
      margin-top: 35px;
    }

    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .related-item {
      background: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: 0.2s;
    }

    .related-item:hover {
      transform: translateY(-3px);
    }

    .related-item img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

<header>
  <div class="container">
    <h1>ğŸ“˜ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø§Ø¨Ù†â€ŒØ­Ø³Ø§Ù…</h1>

    <nav>
      <ul>
        <li><a href="index.html">Ø®Ø§Ù†Ù‡</a></li>
        <li><a href="#">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</a></li>
        <li><a href="#">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a></li>
        <li><a href="#">ØªÙ…Ø§Ø³</a></li>
      </ul>
    </nav>

    <div class="header-icons">
      <span id="userNameDisplay" class="user-name"></span>

      <button id="openAuth" title="ÙˆØ±ÙˆØ¯">ÙˆØ±ÙˆØ¯</button>
      <button id="logoutBtn" style="display:none;" title="Ø®Ø±ÙˆØ¬">ğŸšª</button>

      <div id="userMenu" class="user-menu" style="display:none;">
        <p id="menuUserName"></p>
        <button id="menuProfile">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
      </div>

      <button title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">âš™ï¸</button>
    </div>
  </div>
</header>

<div id="pendingBox">
  Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø¨Ù…Ø§Ù†ÛŒØ¯.
</div>

<div class="book-container">

  <h2 id="bookTitle">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</h2>

  <div class="book-box">
    <img id="bookImg" class="book-img"
         src="https://cdn-icons-png.flaticon.com/512/29/29302.png">

    <div class="book-info">
      <p><strong>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡:</strong> <span id="bookAuthor"></span></p>
      <p><strong>Ø³Ø§Ù„ Ú†Ø§Ù¾:</strong> <span id="bookYear"></span></p>
      <p><strong>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</strong> <span id="bookCategory"></span></p>
      <p><strong>Ù†Ø³Ø®Ù‡ Ù…ÙˆØ¬ÙˆØ¯:</strong> <span id="bookCopies"></span></p>

      <button id="borrowBtn" class="btn-primary">Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ†</button>
    </div>
  </div>

  <div class="related-books">
    <h3 style="color:#1f3c88;">ğŸ“š Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·</h3>
    <div id="relatedGrid" class="related-grid"></div>
  </div>

</div>

<footer>
  <div class="footer-container">
    <div class="footer-col">
      <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡</h3>
      <p>Ø§ÛŒÙ† Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ù‡Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø§Ø¨Ù†â€ŒØ­Ø³Ø§Ù… Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>

    <div class="footer-col">
      <h3>Ù¾ÛŒÙˆÙ†Ø¯Ù‡Ø§ÛŒ Ù…ÙÛŒØ¯</h3>
      <ul>
        <li><a href="#">Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡</a></li>
        <li><a href="#">Ø³ÛŒØ³ØªÙ… Ø¹Ø¶ÙˆÛŒØª</a></li>
      </ul>
    </div>

    <div class="footer-col">
      <h3>Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø§</h3>
      <p>ğŸ“§ info@library.com</p>
      <p>â˜ï¸ Û°ÛµÛ¶</p>
      <p>ğŸ“ Ø¨ÛŒØ±Ø¬Ù†Ø¯ØŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø§Ø¨Ù†â€ŒØ­Ø³Ø§Ù…</p>
    </div>
  </div>

  <p class="copy">Ú©Ù„ÛŒÙ‡ Ø­Ù‚ÙˆÙ‚ Ø§ÛŒÙ† Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
</footer>

<script>
const API = "http://localhost:3000";
const params = new URLSearchParams(window.location.search);
const bookId = params.get("id");

const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "{}");
const isPending = user.role === "pending";
const isMember  = user.role === "member";

/* Ù‡Ø¯Ø± */
function initHeader() {
  if (user?.name) {
    userNameDisplay.textContent = user.name;
    openAuth.style.display = "none";
    logoutBtn.style.display = "inline-block";
    menuUserName.textContent = user.name;

    menuProfile.onclick = () => {
      window.location.href = "member-panel.html";
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "index.html";
    };

    userNameDisplay.onclick = () => {
      userMenu.style.display =
        userMenu.style.display === "none" ? "block" : "none";
    };
  }
}

if (isPending) {
  pendingBox.style.display = "block";
}

/* Ù„ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©ØªØ§Ø¨ */
async function loadBook() {
  const res = await fetch(`${API}/api/public/books`);
  const books = await res.json();

  const book = books.find((b) => b.id == bookId);
  if (!book) {
    alert("Ú©ØªØ§Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯");
    return;
  }

  bookTitle.textContent = book.title;
  bookAuthor.textContent = book.author;
  bookYear.textContent = book.publication_year;
  bookCategory.textContent = book.category ?? "â€”";
  bookCopies.textContent = book.available_copies;

  // Borrow ÙˆØ§Ù‚Ø¹ÛŒ
  if (isPending) {
    borrowBtn.classList.add("disabled");
    borrowBtn.onclick = () =>
      alert("Ù¾Ø³ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù…Ø§Ù†Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
  } else {
    borrowBtn.onclick = () => borrowBook(book.id);
  }

  const related = books.filter(
    (b) => b.category === book.category && b.id != book.id
  );

  relatedGrid.innerHTML = related.length
    ? related.map(b => `
        <div class="related-item"
             onclick="location.href='book.html?id=${b.id}'">
          <img src="https://cdn-icons-png.flaticon.com/512/29/29302.png">
          <p>${b.title}</p>
        </div>
      `).join("")
    : "<p>Ú©ØªØ§Ø¨ Ù…Ø´Ø§Ø¨Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>";
}

/* Borrow */
async function borrowBook(id) {
  if (!token) {
    alert("Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ† Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯");
    return;
  }

  if (!isMember) {
    alert("Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª");
    return;
  }

  const res = await fetch(`${API}/api/borrow`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ book_id: id })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ† Ú©ØªØ§Ø¨");
    return;
  }

  alert(data.message || "Ú©ØªØ§Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ‡ Ø´Ø¯");
  loadBook(); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
}

initHeader();
loadBook();
</script>

</body>
</html>
