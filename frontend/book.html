<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“˜ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©ØªØ§Ø¨ | Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡</title>

  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #1e293b;
      --accent-color: #f59e0b;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #334155;
      --text-light: #64748b;
      --danger: #ef4444;
      --success: #10b981;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.10);
      --shadow-soft: 0 6px 22px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; outline: none; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Vazirmatn', sans-serif;
      background: var(--bg-color);
      color: var(--text-main);
      direction: rtl;
      line-height: 1.7;
    }

    .wrapper { max-width: 1400px; margin: 0 auto; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    /* ---------------- Header (same as your new index) ---------------- */
    header {
      background: rgba(255,255,255,0.85);
      color: var(--secondary-color);
      padding: 14px 0;
      position: sticky;
      top: 0;
      z-index: 999;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(12px);
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    header h1 {
      font-size: 1.15rem;
      margin: 0;
      font-weight: 900;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #0f172a;
      cursor: pointer;
    }

    header h1 .logo-box {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--primary-color);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
    }

    header nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    header nav a {
      color: #334155;
      text-decoration: none;
      padding: 10px 12px;
      display: block;
      transition: all 0.2s;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    header nav a:hover,
    header nav a.active {
      color: var(--primary-color);
      background: rgba(37, 99, 235, 0.08);
    }

    .header-icons {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .header-icons .user-name {
      color: #0f172a;
      font-weight: 800;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(37, 99, 235, 0.10);
      border: 1px solid rgba(37, 99, 235, 0.18);
      display: none;
    }

    .header-icons button {
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 800;
      transition: all 0.2s;
      border-radius: 12px;
      padding: 10px 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Vazirmatn', sans-serif;
    }

    #openAuth {
      background: rgba(37, 99, 235, 0.08);
      color: var(--primary-color);
      border: 1px solid rgba(37, 99, 235, 0.18);
    }
    #openAuth:hover { background: rgba(37, 99, 235, 0.14); }

    #logoutBtn {
      background: var(--danger);
      color: white;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-weight: 900;
      display: none;
    }
    #logoutBtn:hover { filter: brightness(0.95); }

    .user-menu {
      position: absolute;
      top: 56px;
      left: 0;
      right: auto;
      background: white;
      border-radius: 14px;
      box-shadow: var(--shadow-soft);
      padding: 14px;
      min-width: 190px;
      z-index: 1001;
      text-align: right;
      border: 1px solid rgba(15, 23, 42, 0.08);
      display: none;
    }
    .user-menu p {
      margin: 0 0 10px 0;
      font-weight: 900;
      color: var(--primary-color);
      border-bottom: 1px solid #eef2f7;
      padding-bottom: 10px;
    }
    .user-menu button {
      background: var(--primary-color);
      color: white;
      width: 100%;
      margin-top: 10px;
      justify-content: center;
    }
    .user-menu button:hover { background: #1d4ed8; }

    /* Pending */
    #pendingBox {
      background: #fff3cd;
      color: #7f6500;
      border: 1px solid #ffeeba;
      padding: 15px;
      margin: 18px auto 0 auto;
      max-width: 1200px;
      border-radius: 14px;
      text-align: center;
      font-weight: 900;
      font-size: 15px;
      display: none;
    }

    /* ---------------- Page ---------------- */
    main { padding: 26px 0 0; }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #64748b;
      font-weight: 700;
      font-size: 0.92rem;
      margin: 10px 0 18px;
      flex-wrap: wrap;
    }
    .breadcrumb a {
      color: #64748b;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .breadcrumb a:hover { background: rgba(37, 99, 235, 0.08); color: var(--primary-color); }
    .breadcrumb .sep { opacity: 0.6; }

    .details-card {
      background: #fff;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      max-width: 1200px;
  margin: 0 auto;
    }

    .details-inner {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 0;
}

    .details-right {
  background: #f8fafc;
  border-left: 1px solid #eef2f7; /* Ø¨Ù‡â€ŒØ¬Ø§ÛŒ border-right */
  border-right: none;
  padding: 26px;
  display: flex;
  align-items: flex-start;
  justify-content: center;
    align-items: flex-start;
  position: relative;

}


    .badge-status {

      position: absolute;
      top: 14px;
  right: 14px; /* Ú†ÙˆÙ† RTL Ù‡Ø³Øª */
  left: auto;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      color: #0f172a;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgb(16, 185, 129);
      color: #065f46;
    }
    .badge-status.borrowed {
      background: rgba(239,68,68,0.12);
      color: #7f1d1d;
    }

    .cover {
      width: 240px;
      max-width: 100%;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18);
      aspect-ratio: 2/3;
      object-fit: cover;
        align-self: flex-start;

      background: #e5e7eb;
    }

    .details-left {
      padding: 26px;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      gap: 14px;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .book-title {
      margin: 0;
      font-size: 2rem;
      font-weight: 1000;
      color: #0f172a;
      line-height: 1.2;
    }

    .book-author {
      margin: 8px 0 0;
      font-size: 1.05rem;
      font-weight: 800;
      color: #475569;
    }

    .book-author span {
      color: var(--primary-color);
      cursor: pointer;
    }

    .icon-actions {
      display: inline-flex;
      gap: 8px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.10);
      background: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      transition: 0.15s;
    }
    .icon-btn:hover { background: #f1f5f9; color: var(--primary-color); }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin: 16px 0 16px;
    }

    .meta-box {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 12px;
      font-size: 0.92rem;
    }
    .meta-box .lbl { color: #64748b; font-weight: 800; display: flex; align-items: center; gap: 6px; }
    .meta-box .val { margin-top: 6px; font-weight: 1000; color: #0f172a; }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 18px 0 10px;
      font-weight: 1000;
      color: #0f172a;
      font-size: 1.1rem;
    }
    .section-title .material-icons-outlined { color: var(--primary-color); }

    .desc {
      margin: 0;
      color: #334155;
      text-align: justify;
      line-height: 1.95;
    }

    .bottom-row {
      margin-top: 20px;
      padding-top: 18px;
      border-top: 1px solid #eef2f7;
      display: flex;
      justify-content: space-between;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
    }

    .stocks {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .stock-box {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      background: #fff;
      min-width: 170px;
    }
    .stock-box .s-lbl { font-size: 0.88rem; color: #64748b; font-weight: 800; }
    .stock-box .s-val { font-size: 1.25rem; font-weight: 1000; color: #0f172a; }
    .stock-box .s-val.green { color: #15803d; }

    .cta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      cursor: pointer;
      border-radius: 14px;
      padding: 12px 16px;
      font-weight: 1000;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: 0.15s;
      min-width: 160px;
    }
    .btn.primary { background: var(--primary-color); color: #fff; box-shadow: 0 16px 30px rgba(37,99,235,0.25); }
    .btn.primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn.outline { background: #fff; color: var(--primary-color); border: 1px solid rgba(37,99,235,0.35); }
    .btn.outline:hover { background: rgba(37,99,235,0.08); }
    .btn.disabled { background: #9ca3af !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

    /* ---------------- Similar books ---------------- */
    .block {
      margin-top: 34px;
    }

    .block-head {
      display: flex;
      justify-content: space-between;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .block-head h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 1000;
      color: #0f172a;
    }

    .block-head a {
      text-decoration: none;
      color: var(--primary-color);
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .block-head a:hover { text-decoration: underline; }

    .related-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 16px;
    }

    .related-item {
      background: #fff;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.18s, box-shadow 0.18s;
      display: flex;
      flex-direction: column;
    }
    .related-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 35px rgba(0,0,0,0.10);
    }

    .related-item img {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      background: #e5e7eb;
    }

    .related-item .r-body {
      padding: 10px 10px 12px;
    }
    .related-item .r-title {
      margin: 0;
      font-weight: 1000;
      color: #0f172a;
      font-size: 0.92rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .related-item .r-author {
      margin: 6px 0 0;
      color: #64748b;
      font-weight: 800;
      font-size: 0.78rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ---------------- Comments (UI) ---------------- */
    .comments-card {
      background: #fff;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      padding: 18px;
    }

    .comment-form {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 14px;
    }
    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      flex: 0 0 auto;
    }
    .comment-form textarea {
      width: 100%;
      min-height: 74px;
      resize: none;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      padding: 12px 12px;
      font-family: 'Vazirmatn', sans-serif;
      font-weight: 700;
    }
    .comment-form textarea:focus { border-color: rgba(37,99,235,0.6); background: #fff; }

    .comment-form .submit-wrap {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }
    .btn.small { min-width: 120px; padding: 10px 14px; border-radius: 12px; font-size: 0.92rem; }

    .comment-item {
      padding: 14px 0;
      border-top: 1px solid #eef2f7;
    }
    .comment-head {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .comment-head .name { font-weight: 1000; color: #0f172a; font-size: 0.95rem; }
    .comment-head .time { color: #64748b; font-weight: 800; font-size: 0.78rem; margin-right: 4px; }
    .stars { margin-right: auto; display: inline-flex; gap: 2px; color: #fbbf24; }
    .comment-text {
      margin: 8px 52px 0 0;
      color: #334155;
      font-weight: 700;
      font-size: 0.92rem;
      line-height: 1.9;
    }

    /* ---------------- Footer (same as index) ---------------- */
    footer {
      background: #1e293b;
      color: #cbd5e1;
      padding: 40px 20px 20px;
      margin-top: 60px;
    }

    .footer-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 30px;
      padding-bottom: 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .footer-col h3 {
      color: white;
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .footer-col ul { list-style: none; padding: 0; }
    .footer-col ul a {
      color: #cbd5e1;
      text-decoration: none;
      display: block;
      padding: 5px 0;
      transition: color 0.3s;
    }
    .footer-col ul a:hover { color: #93c5fd; }

    .copy { text-align: center; margin-top: 20px; font-size: 0.85rem; }

    /* ---------------- Modal (same as index) ---------------- */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: zoomIn 0.3s;
      border: 1px solid rgba(15, 23, 42, 0.10);
    }

    @keyframes zoomIn {
      from { transform: scale(0.92); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .close-btn {
      color: var(--text-light);
      float: left;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 15px;
      left: 15px;
      transition: color 0.3s;
    }
    .close-btn:hover { color: var(--danger); }

    .modal-content h2 {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      color: #0f172a;
      font-weight: 1000;
    }

    .modal-content input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-sizing: border-box;
      font-family: 'Vazirmatn', sans-serif;
      transition: border-color 0.3s;
    }
    .modal-content input:focus { border-color: var(--primary-color); }

    .modal-content button {
      width: 100%;
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 900;
      font-family: 'Vazirmatn', sans-serif;
      transition: background-color 0.3s;
    }
    .modal-content button:hover { background-color: #1d4ed8; }

    .switch-form {
      text-align: center;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    .switch-form a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 900;
    }
    #loginMsg, #signupMsg { text-align: center; margin-top: 10px; font-weight: 900; }

    @media (max-width: 1100px) {
      .details-inner { grid-template-columns: 1fr; }
      .details-right { border-right: 0; border-bottom: 1px solid #eef2f7; }
      .related-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .meta-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 680px) {
      header .container { flex-direction: column; gap: 12px; }
      header nav ul { justify-content: center; flex-wrap: wrap; }
      .related-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .book-title { font-size: 1.6rem; }
      .btn { width: 100%; }
      .stock-box { width: 100%; min-width: 0; }
    }
  </style>
</head>

<body>
  <div class="wrapper">

    <header>
      <div class="container">
        <h1 onclick="location.href='index.html'">
          <span class="logo-box">
            <span class="material-icons-outlined">local_library</span>
          </span>
          Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø§Ø¨Ù†â€ŒØ­Ø³Ø§Ù…
        </h1>

        <nav>
          <ul>
            <li><a href="index.html">Ø®Ø§Ù†Ù‡</a></li>
            <li><a href="index.html#bookGrid">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</a></li>
            <li><a href="#" onclick="return false;">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a></li>
            <li><a href="#" onclick="return false;">ØªÙ…Ø§Ø³</a></li>
          </ul>
        </nav>

        <div class="header-icons">
          <span id="userNameDisplay" class="user-name"></span>

          <button id="openAuth" title="ÙˆØ±ÙˆØ¯">
            <span class="material-icons-outlined" style="font-size:20px;">login</span>
            ÙˆØ±ÙˆØ¯
          </button>

          <button id="logoutBtn" title="Ø®Ø±ÙˆØ¬">
            <span class="material-icons-outlined" style="font-size:20px;">logout</span>
            Ø®Ø±ÙˆØ¬
          </button>

          <div id="userMenu" class="user-menu">
            <p id="menuUserName">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±</p>
            <button id="menuProfile">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
          </div>
        </div>
      </div>
    </header>

    <div id="pendingBox" class="container">
      Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø¨Ù…Ø§Ù†ÛŒØ¯.
    </div>

    <main class="container">

      <div class="breadcrumb">
        <a href="index.html"><span class="material-icons-outlined" style="font-size:18px;">home</span> Ø®Ø§Ù†Ù‡</a>
        <span class="sep">â€¹</span>
        <a href="index.html#bookGrid">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</a>
        <span class="sep">â€¹</span>
        <a href="#" id="crumbCategory" onclick="return false;">â€”</a>
        <span class="sep">â€¹</span>
        <span id="crumbTitle" style="color:#94a3b8;font-weight:900;">â€”</span>
      </div>

      <section class="details-card">
        <div class="details-inner">

          <aside class="details-right">
            <span id="statusBadge" class="badge-status">Ù…ÙˆØ¬ÙˆØ¯</span>
            <img id="bookImg" class="cover" src="https://cdn-icons-png.flaticon.com/512/29/29302.png" alt="Ø¬Ù„Ø¯ Ú©ØªØ§Ø¨" />
          </aside>

          <div class="details-left">
            <div class="title-row">
              <div>
                <h1 id="bookTitle" class="book-title">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</h1>
                <div class="book-author">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: <span id="bookAuthor">â€”</span></div>
              </div>

              <div class="icon-actions">
                <button class="icon-btn" title="Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§" type="button" onclick="alert('ÙØ¹Ù„Ø§Ù‹ Ù†Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª ğŸ™‚')">
                  <span class="material-icons-outlined">favorite_border</span>
                </button>
                <button class="icon-btn" title="Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ" type="button" onclick="copyShareLink()">
                  <span class="material-icons-outlined">share</span>
                </button>
              </div>
            </div>

            <div class="meta-grid">
              <div class="meta-box">
                <div class="lbl"><span class="material-icons-outlined" style="font-size:18px;">category</span>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</div>
                <div class="val" id="bookCategory">â€”</div>
              </div>
              <div class="meta-box">
                <div class="lbl"><span class="material-icons-outlined" style="font-size:18px;">calendar_today</span>Ø³Ø§Ù„ Ú†Ø§Ù¾</div>
                <div class="val" id="bookYear">â€”</div>
              </div>
              <div class="meta-box">
                <div class="lbl"><span class="material-icons-outlined" style="font-size:18px;">qr_code</span>Ø´Ø§Ø¨Ú© (ISBN)</div>
                <div class="val" id="bookISBN">â€”</div>
              </div>
              <div class="meta-box">
                <div class="lbl"><span class="material-icons-outlined" style="font-size:18px;">inventory_2</span>Ø´Ù…Ø§Ø±Ù‡ Ù‚ÙØ³Ù‡</div>
                <div class="val" id="bookShelf">â€”</div>
              </div>
            </div>

            <div class="section-title">
              <span class="material-icons-outlined">description</span>
            </div>
            <p id="bookDesc" class="desc"></p>

            <div class="bottom-row">
              <div class="stocks">
                <div class="stock-box">
                  <div class="s-lbl">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø± Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡:</div>
                  <div class="s-val"><span id="copiesTotal">â€”</span> Ø¬Ù„Ø¯</div>
                </div>
                <div class="stock-box">
                  <div class="s-lbl">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³:</div>
                  <div class="s-val green"><span id="copiesAvailable">â€”</span> Ø¬Ù„Ø¯</div>
                </div>
              </div>

              <div class="cta">
                <button id="reserveBtn" class="btn outline" type="button" onclick="alert('Ø±Ø²Ø±Ùˆ ÙØ¹Ù„Ø§Ù‹ Ù†Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª')">
                  <span class="material-icons-outlined">bookmark_border</span>
                  Ø±Ø²Ø±Ùˆ Ú©ØªØ§Ø¨
                </button>

                <button id="borrowBtn" class="btn primary" type="button">
                  <span class="material-icons-outlined">library_add</span>
                  Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ†
                </button>
              </div>
            </div>

          </div>
        </div>
      </section>

      <section class="block">
        <div class="block-head">
          <h3>Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡</h3>
          <a href="index.html#bookGrid">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ <span class="material-icons-outlined" style="font-size:18px;">arrow_back</span></a>
        </div>

        <div id="relatedGrid" class="related-grid"></div>
      </section>

      

    </main>

    <footer>
      <div class="container">
        <div class="footer-container">
          <div class="footer-col">
            <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡</h3>
            <p>Ø§ÛŒÙ† Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ù‡Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø§Ø¨Ù†â€ŒØ­Ø³Ø§Ù… Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù‡Ø¯ÙØŒ Ø³Ù‡ÙˆÙ„Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¹Ø¶Ø§ Ø¨Ù‡ Ù…Ù†Ø§Ø¨Ø¹ Ø§Ø³Øª.</p>
          </div>

          <div class="footer-col">
            <h3>Ù¾ÛŒÙˆÙ†Ø¯Ù‡Ø§ÛŒ Ù…ÙÛŒØ¯</h3>
            <ul>
              <li><a href="index.html#bookGrid">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</a></li>
              <li><a href="#" onclick="return false;">Ø³ÛŒØ³ØªÙ… Ø¹Ø¶ÙˆÛŒØª</a></li>
              <li><a href="#" onclick="return false;">Ù†Ù‚Ø´Ù‡ Ø³Ø§ÛŒØª</a></li>
            </ul>
          </div>

          <div class="footer-col">
            <h3>Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø§</h3>
            <p>ğŸ“§ info@ibnhesam.ac.ir</p>
            <p>â˜ï¸ Û°ÛµÛ¶-Û³Û²Û²Û´Û°Û°Û°</p>
            <p>ğŸ“ Ø¨ÛŒØ±Ø¬Ù†Ø¯ØŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø§Ø¨Ù†â€ŒØ­Ø³Ø§Ù…</p>
          </div>
        </div>

        <p class="copy">Â© Ú©Ù„ÛŒÙ‡ Ø­Ù‚ÙˆÙ‚ Ø§ÛŒÙ† Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
      </div>
    </footer>

    <!-- AUTH MODAL -->
    <div id="authModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">âœ–</span>

        <div id="loginFormBox">
          <h2>ğŸ”‘ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</h2>
          <input type="email" id="loginEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„" required>
          <input type="password" id="loginPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required>
          <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
          <p class="switch-form">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯ÛŒØŸ <a href="#" onclick="showSignup()">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨</a></p>
          <p id="loginMsg"></p>
        </div>

        <div id="signupFormBox" style="display:none;">
          <h2>ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h2>
          <input type="text" id="signupName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required>
          <input type="email" id="signupEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„" required>
          <input type="password" id="signupPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required>
          <input type="password" id="signupPassword2" placeholder="ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required>

          <button onclick="signup()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
          <p class="switch-form">Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø±ÛŒØŸ <a href="#" onclick="showLogin()">ÙˆØ±ÙˆØ¯</a></p>
          <p id="signupMsg"></p>
        </div>
      </div>
    </div>

  </div>

  <script>
    const API = "http://localhost:3000";
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get("id");

    const modal = document.getElementById("authModal");
    const loginBox = document.getElementById("loginFormBox");
    const signupBox = document.getElementById("signupFormBox");

    const userNameDisplay = document.getElementById("userNameDisplay");
    const logoutBtn = document.getElementById("logoutBtn");
    const openAuth = document.getElementById("openAuth");
    const menuUserName = document.getElementById("menuUserName");
    const menuProfile = document.getElementById("menuProfile");
    const userMenu = document.getElementById("userMenu");
    const pendingBox = document.getElementById("pendingBox");

    const statusBadge = document.getElementById("statusBadge");
    const borrowBtn = document.getElementById("borrowBtn");

    const state = {
      book: null,
      allBooks: []
    };

    // --------- Auth modal ----------
    openAuth.onclick = () => {
      modal.style.display = "flex";
      showLogin();
    };

    function closeModal() { modal.style.display = "none"; }

    function showSignup() {
      loginBox.style.display = "none";
      signupBox.style.display = "block";
      signupMsg.textContent = "";
    }

    function showLogin() {
      signupBox.style.display = "none";
      loginBox.style.display = "block";
      loginMsg.textContent = "";
    }

    async function signup() {
      const name = signupName.value;
      const email = signupEmail.value;
      const password = signupPassword.value;
      const pass2 = signupPassword2.value;

      if (password !== pass2) {
        signupMsg.textContent = "âŒ Ø±Ù…Ø²Ù‡Ø§ ÛŒÚ©Ø³Ø§Ù† Ù†ÛŒØ³ØªÙ†Ø¯";
        signupMsg.style.color = "var(--danger)";
        return;
      }

      const res = await fetch(`${API}/api/signup`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({name,email,password})
      });

      const data = await res.json();
      signupMsg.textContent = data.message || data.error;
      signupMsg.style.color = data.error ? "var(--danger)" : "var(--success)";

      if (!data.error) setTimeout(showLogin, 1500);
    }

    async function login() {
      const email = loginEmail.value;
      const password = loginPassword.value;

      const res = await fetch(`${API}/api/login`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({email,password})
      });

      const data = await res.json();

      if (data.token) {
        localStorage.setItem("token", data.token);
        localStorage.setItem("user", JSON.stringify(data.user));
        closeModal();
        window.location.reload();
      } else {
        loginMsg.textContent = data.error;
        loginMsg.style.color = "var(--danger)";
      }
    }

    // --------- Header state ----------
    function initHeader() {
      const savedUser = localStorage.getItem("user");
      if (!savedUser) return;

      const u = JSON.parse(savedUser);
      if (!u?.name) return;

      userNameDisplay.textContent = u.name;
      userNameDisplay.style.display = "inline-flex";
      logoutBtn.style.display = "inline-flex";
      openAuth.style.display = "none";

      menuUserName.textContent = u.name;

      if (u.role === "pending") pendingBox.style.display = "block";

      menuProfile.onclick = () => {
        if (u.role === "admin") window.location.href = "admin-panel.html";
        else window.location.href = "member-panel.html";
      };
    }

    logoutBtn.onclick = () => {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.reload();
    };

    userNameDisplay.onclick = () => {
      userMenu.style.display = (userMenu.style.display === "none" || userMenu.style.display === "") ? "block" : "none";
    };

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".header-icons") && userMenu) userMenu.style.display = "none";
    });

    // --------- Share ----------
    function copyShareLink() {
      try {
        navigator.clipboard.writeText(window.location.href);
        alert("Ù„ÛŒÙ†Ú© ØµÙØ­Ù‡ Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
      } catch {
        alert("Ú©Ù¾ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯. Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¯Ø³ØªÛŒ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.");
      }
    }

    // --------- Data ----------
    async function loadAllBooks() {
      const res = await fetch(`${API}/api/public/books`);
      const books = await res.json();
      state.allBooks = Array.isArray(books) ? books : [];
    }

    async function loadBook() {
      if (!bookId) {
        alert("Ø´Ù†Ø§Ø³Ù‡ Ú©ØªØ§Ø¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
        return;
      }

      // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù„ÛŒØ³Øª Ø±Ùˆ Ù„ÙˆØ¯ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒÙ…
      if (!state.allBooks.length) await loadAllBooks();

      const book = state.allBooks.find(b => String(b.id) === String(bookId));
      if (!book) {
        alert("Ú©ØªØ§Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯");
        return;
      }

      state.book = book;

      // Fill UI
      document.getElementById("bookTitle").textContent = book.title || "â€”";
      document.getElementById("crumbTitle").textContent = book.title || "â€”";

      document.getElementById("bookAuthor").textContent = book.author || "â€”";
      document.getElementById("bookYear").textContent = book.publication_year ?? "â€”";
      document.getElementById("bookCategory").textContent = book.category ?? "â€”";
      document.getElementById("crumbCategory").textContent = book.category ?? "â€”";
      document.getElementById("bookISBN").textContent = book.isbn ?? "â€”";
      document.getElementById("bookShelf").textContent = book.shelf_code ?? "â€”";
      document.getElementById("bookDesc").textContent = book.description ?? "â€”";

      const imgUrl = book.image ? `${API}${book.image}` : "https://cdn-icons-png.flaticon.com/512/29/29302.png";
      document.getElementById("bookImg").src = imgUrl;

      // Copies
      const available = Number(book.available_copies ?? 0);
      const total = Number(book.total_copies ?? book.copies ?? book.total ?? available);

      document.getElementById("copiesTotal").textContent = isNaN(total) ? available : total;
      document.getElementById("copiesAvailable").textContent = isNaN(available) ? 0 : available;

      // Status badge
      if (available > 0) {
        statusBadge.textContent = "Ù…ÙˆØ¬ÙˆØ¯";
        statusBadge.classList.remove("borrowed");
      } else {
        statusBadge.textContent = "Ø§Ù…Ø§Ù†Øª";
        statusBadge.classList.add("borrowed");
      }

      setupBorrowButton(book, available);

      renderRelated(book);
    }

    function setupBorrowButton(book, available) {
      const token = localStorage.getItem("token");
      const u = JSON.parse(localStorage.getItem("user") || "{}");

      // Not logged in
      if (!token) {
        borrowBtn.classList.add("disabled");
        borrowBtn.onclick = () => {
          alert("Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ† Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯.");
          modal.style.display = "flex";
          showLogin();
        };
        return;
      }

      // Pending
      if (u.role === "pending") {
        borrowBtn.classList.add("disabled");
        borrowBtn.onclick = () => alert("Ù¾Ø³ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù…Ø§Ù†Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
        return;
      }

      // Available?
      if (available <= 0) {
        borrowBtn.classList.add("disabled");
        borrowBtn.onclick = () => alert("Ø§ÛŒÙ† Ú©ØªØ§Ø¨ ÙØ¹Ù„Ø§Ù‹ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.");
        return;
      }

      // Member/admin allowed? (ØªÙˆ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§Øª Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ member)
      borrowBtn.classList.remove("disabled");
      borrowBtn.onclick = () => borrowBook(book.id);
    }

    async function borrowBook(id) {
      const token = localStorage.getItem("token");
      const u = JSON.parse(localStorage.getItem("user") || "{}");

      if (!token || (u.role !== "member" && u.role !== "admin")) {
        alert("Ø´Ù…Ø§ Ù…Ø¬ÙˆØ² Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯.");
        return;
      }

      const res = await fetch(`${API}/api/borrow`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ book_id: id })
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ† Ú©ØªØ§Ø¨.");
        return;
      }

      alert(
        (data.message || "Ú©ØªØ§Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù…Ø§Ù†Øª Ú¯Ø±ÙØªÙ‡ Ø´Ø¯.") +
        (data.due_date ? "\nğŸ“… ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ú¯Ø´Øª: " + data.due_date : "")
      );

      // refresh
      await loadAllBooks();
      await loadBook();
    }

    function renderRelated(book) {
      const grid = document.getElementById("relatedGrid");
      const related = state.allBooks
        .filter(b => b.category && book.category && b.category === book.category && String(b.id) !== String(book.id))
        .slice(0, 12);

      if (!related.length) {
        grid.innerHTML = `<div style="grid-column:1/-1;color:#64748b;font-weight:900;">Ú©ØªØ§Ø¨ Ù…Ø´Ø§Ø¨Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>`;
        return;
      }

      grid.innerHTML = related.map(b => {
        const img = b.image ? `${API}${b.image}` : "https://cdn-icons-png.flaticon.com/512/29/29302.png";
        return `
          <div class="related-item" onclick="location.href='book.html?id=${b.id}'">
            <img src="${img}" alt="Ø¬Ù„Ø¯ Ú©ØªØ§Ø¨">
            <div class="r-body">
              <p class="r-title" title="${b.title || ''}">${b.title || 'â€”'}</p>
              <p class="r-author" title="${b.author || ''}">${b.author || ''}</p>
            </div>
          </div>
        `;
      }).join("");
    }

    // init
    initHeader();
    loadBook();
  </script>
</body>
</html>
