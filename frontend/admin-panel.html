<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ğŸ› Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      display: flex;
      background: #f4f7fb;
    }

    /* Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± */
    .sidebar {
      width: 240px;
      height: 100vh;
      background: #1f3c88;
      color: white;
      padding: 25px 20px;
      position: fixed;
      top: 0;
      right: 0;
      box-shadow: -2px 0 6px rgba(0,0,0,0.2);
    }

    .sidebar h2 {
      font-size: 22px;
      margin-bottom: 25px;
      text-align: center;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      padding: 12px;
      background: rgba(255,255,255,0.1);
      margin-bottom: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: .2s;
    }

    .sidebar ul li:hover,
    .sidebar ul li.active {
      background: #f9b234;
      color: #222;
      font-weight: bold;
    }

    /* Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ */
    .content {
      margin-right: 260px;
      padding: 25px;
      width: 100%;
    }

    .section {
      display: none;
      animation: fade .4s ease;
    }

    .section.active {
      display: block;
    }

    @keyframes fade {
      from {opacity: 0;}
      to {opacity: 1;}
    }

    /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
    .dashboard-cards {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 250px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .card h3 {
      color: #1f3c88;
    }

    /* ÙØ±Ù…â€ŒÙ‡Ø§ */
    .form-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      width: 450px;
    }

    .form-box input,
    .form-box select {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .form-box button {
      background: #1f3c88;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ */
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    th {
      background: #1f3c88;
      color: white;
    }

    .btn-del {
      background: red;
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    }

    .btn-edit {
      background: #f9b234;
      color: #222;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    }
  </style>

</head>
<body>

  <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± -->
  <div class="sidebar">
    <h2>ğŸ› Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</h2>
    <ul>
      <li class="active" onclick="showSection('dashboard')">ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</li>
      <li onclick="showSection('books')">ğŸ“š Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</li>
      <li onclick="showSection('addBook')">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨</li>
      <li onclick="showSection('users')">ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</li>
      <li onclick="showSection('stats')">ğŸ“Š Ø¢Ù…Ø§Ø±</li>
      <li onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</li>
    </ul>
  </div>

  <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
  <div class="content">

    <!-- Ø¨Ø®Ø´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
    <div id="dashboard" class="section active">
      <h2>ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
      <div class="dashboard-cards">
        <div class="card">
          <h3>ğŸ“š ØªØ¹Ø¯Ø§Ø¯ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h3>
          <p id="countBooks">...</p>
        </div>
        <div class="card">
          <h3>ğŸ‘¤ Ø§Ø¹Ø¶Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</h3>
          <p id="countUsers">...</p>
        </div>
        <div class="card">
          <h3>ğŸ” Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h3>
          <p id="countBorrows">...</p>
        </div>
      </div>
    </div>

    <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ -->
    <div id="books" class="section">
      <h2>ğŸ“š Ù…Ø¯ÛŒØ±ÛŒØª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h2>
      <table>
        <thead>
          <tr>
            <th>Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</th>
            <th>Ø³Ø§Ù„</th>
            <th>Ù†Ø³Ø®Ù‡ Ù…ÙˆØ¬ÙˆØ¯</th>
            <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="booksTable"></tbody>
      </table>
    </div>

    <!-- Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ -->
    <div id="addBook" class="section">
      <h2>â• Ø§ÙØ²ÙˆØ¯Ù† Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯</h2>
      <div class="form-box">
        <input id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú©ØªØ§Ø¨">
        <input id="author" placeholder="Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡">
        <input id="year" placeholder="Ø³Ø§Ù„ Ú†Ø§Ù¾">
        <input id="category" placeholder="Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ">
        <input id="copies" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡">
        <button onclick="saveBook()">Ø«Ø¨Øª</button>
      </div>
    </div>

    <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
    <div id="users" class="section">
      <h2>ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>

      <!-- Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯ -->
      <button onclick="showAddMemberForm()" style="margin-bottom:15px;background:#1f3c88;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;">
        â• Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯
      </button>

      <!-- ÙØ±Ù… Ø«Ø¨Øª Ø¹Ø¶Ùˆ -->
      <div id="addMemberBox" class="form-box" style="display:none;margin-top:15px;">
        <h3>Ø«Ø¨Øª Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯</h3>
        <input id="mName" placeholder="Ù†Ø§Ù…">
        <input id="mEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„">
        <input id="mPassword" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <select id="mRole">
          <option value="member">Ø¹Ø¶Ùˆ</option>
          <option value="admin">Ù…Ø¯ÛŒØ±</option>
        </select>
        <button onclick="addMember()">Ø«Ø¨Øª</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Ù†Ø§Ù…</th>
            <th>Ø§ÛŒÙ…ÛŒÙ„</th>
            <th>Ù†Ù‚Ø´</th>
            <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
            <th>ØªØ§ÛŒÛŒØ¯</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <!-- Ø¢Ù…Ø§Ø± -->
    <div id="stats" class="section">
      <h2>ğŸ“Š Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h2>
      <p>Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡...</p>
    </div>

  </div>

<script>

    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");

      document.querySelectorAll(".sidebar ul li").forEach(li => li.classList.remove("active"));
      event.target.classList.add("active");
    }

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    const API = "http://localhost:3000";
    const token = localStorage.getItem("token");

    /* -----------------------------
       Ù„ÙˆØ¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    -----------------------------*/
    async function loadDashboard() {
      try {
        const resBooks = await fetch(`${API}/api/stats/books`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const books = await resBooks.json();
        document.getElementById("countBooks").innerText = books.count;

        const resUsers = await fetch(`${API}/api/stats/users`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const users = await resUsers.json();
        document.getElementById("countUsers").innerText = users.count;

        const resBorrows = await fetch(`${API}/api/stats/borrows`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const borrows = await resBorrows.json();
        document.getElementById("countBorrows").innerText = borrows.count;

      } catch (err) {
        console.log("âŒ Error loading dashboard:", err);
      }
    }

    /* -----------------------------
       Ù„ÙˆØ¯ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§
    -----------------------------*/
    async function loadBooks() {
      const res = await fetch(`${API}/api/books`, {
        headers: { Authorization: "Bearer " + token },
      });
      const books = await res.json();

      document.getElementById("booksTable").innerHTML = books
        .map(
          (b) => `
        <tr>
          <td>${b.title}</td>
          <td>${b.author}</td>
          <td>${b.publication_year}</td>
          <td>${b.available_copies}</td>
          <td><button class="btn-edit" onclick='editBook(${JSON.stringify(b)})'>ÙˆÛŒØ±Ø§ÛŒØ´</button></td>
          <td><button class="btn-del" onclick="deleteBook(${b.id})">Ø­Ø°Ù</button></td>
        </tr>`
        )
        .join("");
    }

    /* -----------------------------
       ØªØ§Ø¨Ø¹ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©ØªØ§Ø¨
    -----------------------------*/
    function editBook(book) {
      const newTitle = prompt("Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯:", book.title);
      const newAuthor = prompt("Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯:", book.author);
      const newYear = prompt("Ø³Ø§Ù„ Ø¬Ø¯ÛŒØ¯:", book.publication_year);
      const newCategory = prompt("Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯:", book.category);
      const newCopies = prompt("Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯:", book.available_copies);

      fetch(`${API}/api/books/${book.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({
          title: newTitle,
          author: newAuthor,
          publication_year: newYear,
          category: newCategory,
          available_copies: newCopies
        })
      }).then(() => {
        alert("Ú©ØªØ§Ø¨ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯");
        loadBooks();
      });
    }

    /* -----------------------------
       Ø°Ø®ÛŒØ±Ù‡ Ú©ØªØ§Ø¨ Ø¬Ø¯ÛŒØ¯
    -----------------------------*/
    async function saveBook() {
      const title = title.value;
      const author = author.value;
      const year = year.value;
      const category = category.value;
      const copies = copies.value;

      fetch(`${API}/api/books`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          title,
          author,
          category,
          publication_year: year,
          available_copies: copies
        })
      })
      .then(res => res.json())
      .then(() => {
        alert("Ú©ØªØ§Ø¨ Ø«Ø¨Øª Ø´Ø¯");
        loadBooks();
      });
    }

    /* -----------------------------
       Ø­Ø°Ù Ú©ØªØ§Ø¨
    -----------------------------*/
    async function deleteBook(id) {
      if (!confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;

      await fetch(`${API}/api/books/${id}`, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token },
      });

      alert("Ú©ØªØ§Ø¨ Ø­Ø°Ù Ø´Ø¯");
      loadBooks();
    }

    /* =============================
       Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ø¶Ø§
    =============================*/

    function showAddMemberForm() {
      addMemberBox.style.display = "block";
    }

    /* Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ */
    async function addMember() {
      const name = mName.value;
      const email = mEmail.value;
      const password = mPassword.value;
      const role = mRole.value;

      const res = await fetch(`${API}/api/admin/users`, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ name, email, password, role })
      });

      const data = await res.json();
      alert(data.message || data.error);

      loadUsers();
    }

    /* ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø¶Ùˆ */
    function editUser(u) {
      const newName = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:", u.name);
      const newEmail = prompt("Ø§ÛŒÙ…ÛŒÙ„ Ø¬Ø¯ÛŒØ¯:", u.email);
      const newRole = prompt("Ù†Ù‚Ø´ Ø¬Ø¯ÛŒØ¯ (admin/member):", u.role);

      fetch(`${API}/api/admin/users/${u.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({
          name: newName,
          email: newEmail,
          role: newRole
        })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        loadUsers();
      });
    }

    /* Ø­Ø°Ù Ø¹Ø¶Ùˆ */
    function deleteUser(id) {
      if (!confirm("Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±ØŸ")) return;

      fetch(`${API}/api/admin/users/${id}`, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        loadUsers();
      });
    }

    /* ØªØ§ÛŒÛŒØ¯ Ø¹Ø¶Ùˆ Pending */
    async function approveUser(id) {
      await fetch(`${API}/api/users/${id}/approve`, {
        method: "PUT",
        headers: { Authorization: "Bearer " + token },
      });

      alert("Ú©Ø§Ø±Ø¨Ø± ØªØ§ÛŒÛŒØ¯ Ø´Ø¯");
      loadUsers();
    }

    /* -----------------------------
       Ù„ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    -----------------------------*/
    async function loadUsers() {
      const res = await fetch(`${API}/api/users`, {
        headers: { Authorization: "Bearer " + token },
      });
      const users = await res.json();

      usersTable.innerHTML = users
        .map(
          (u) => `
        <tr>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>${u.role}</td>

          <td><button class="btn-edit" onclick='editUser(${JSON.stringify(u)})'>ÙˆÛŒØ±Ø§ÛŒØ´</button></td>

          <td>
            ${
              u.role === "pending"
                ? `<button class="btn-edit" onclick="approveUser(${u.id})">ØªØ§ÛŒÛŒØ¯</button>`
                : "âœ”"
            }
          </td>

          <td>
            <button class="btn-del" onclick="deleteUser(${u.id})">Ø­Ø°Ù</button>
          </td>
        </tr>`
        )
        .join("");
    }

    /* -----------------------------
       Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    -----------------------------*/
    loadBooks();
    loadUsers();
    loadDashboard();

</script>

</body>
</html>
