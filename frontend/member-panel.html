<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“˜ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    :root {
      --primary-color: #1a2b4b;
      --secondary-color: #f0f4f8;
      --accent-color: #4CAF50;
      --danger-color: #e6525a;
    }
    
    body {
      background: var(--secondary-color);
      direction: rtl;
      margin: 0;
      font-family: "Vazirmatn", sans-serif;
      line-height: 1.6;
    }

    .container-panel {
      max-width: 900px;
      width: 92%;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: var(--primary-color);
      margin-bottom: 30px;
      text-align: center;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      font-weight: 700;
    }

    h3 {
      color: var(--primary-color);
      border-right: 4px solid var(--accent-color);
      padding-right: 10px;
      margin-top: 30px;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .pending-msg {
      background: #fff8e1;
      border: 1px solid #ffecb3;
      padding: 18px;
      border-radius: 12px;
      font-size: 16px;
      color: #7f6500;
      margin-bottom: 30px;
      text-align: center;
      font-weight: 600;
    }

    .profile-box {
      padding: 25px;
      border-radius: 12px;
      background: #fcfcfc;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 30px;
      border: 1px solid #eee;
    }

    .profile-box label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      color: var(--primary-color);
      font-weight: 500;
    }

    .profile-box input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      background: white;
    }

    th, td {
      padding: 15px 12px;
      text-align: right;
      font-size: 15px;
    }

    th {
      background: var(--primary-color);
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f7f9fb;
    }

    .home-btn {
      display: inline-block;
      text-decoration: none;
      background: #777;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-top: 25px;
    }

    .logout-btn {
      margin-top: 15px;
      display: block;
      width: 100%;
      background: var(--danger-color);
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      font-size: 16px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<div class="container-panel">
  <h2>ğŸ“˜ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±</h2>

  <div id="pendingMsg" class="pending-msg" style="display:none;">
    Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
  </div>

  <div class="profile-box">
    <h3>ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h3>

    <label>Ù†Ø§Ù…:</label>
    <input id="nameField" type="text">

    <label>Ø§ÛŒÙ…ÛŒÙ„:</label>
    <input id="emailField" type="text" disabled>

    <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯:</label>
    <input id="passwordField" type="password">

    <label>ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§:</label>
    <input id="expireField" type="text" disabled value="1404/01/01 (Ù†Ù…ÙˆÙ†Ù‡)">

    <button onclick="updateProfile()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
  </div>

  <h3>ğŸ” Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</h3>

  <table>
    <thead>
      <tr>
        <th>Ú©ØªØ§Ø¨</th>
        <th>ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª</th>
        <th>ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ú¯Ø´Øª</th>
      </tr>
    </thead>
    <tbody id="borrowTable">
      <tr><td colspan="3">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
    </tbody>
  </table>

  <a href="index.html" class="home-btn">ğŸ“š Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
  <button class="logout-btn" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const API = "http://localhost:3000";
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "{}");

if (!token || !user) location.href = "index.html";
if (user.role === "admin") location.href = "admin-panel.html";

if (user.role === "pending") {
  pendingMsg.style.display = "block";
}

nameField.value = user.name;
emailField.value = user.email;

/* ğŸ” Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± */
async function loadMyBorrows() {
  const tbody = document.getElementById("borrowTable");

  try {
    const res = await fetch(`${API}/api/my-borrows`, {
      headers: { Authorization: "Bearer " + token }
    });

    const data = await res.json();

    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="3">Ø§Ù…Ø§Ù†ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map(b => `
      <tr>
        <td>${b.title}</td>
        <td>${new Date(b.borrow_date).toLocaleDateString("fa-IR")}</td>
        <td>${b.return_date ? new Date(b.return_date).toLocaleDateString("fa-IR") : "â€”"}</td>
      </tr>
    `).join("");

  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="3">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</td></tr>`;
  }
}

async function updateProfile() {
  const newName = nameField.value.trim();
  const newPassword = passwordField.value.trim();

  if (!newName) return alert("Ù†Ø§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯");

  await fetch(`${API}/api/profile`, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ name: newName, password: newPassword })
  });

  user.name = newName;
  localStorage.setItem("user", JSON.stringify(user));
  alert("Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
}

function logout() {
  localStorage.clear();
  location.href = "index.html";
}

loadMyBorrows();
</script>

</body>
</html>
