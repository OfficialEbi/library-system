<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“˜ Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

  <style>
    /* --- Ù…ØªØºÛŒØ±Ù‡Ø§ --- */
    :root {
      --primary-color: #1a2b4b; /* Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡ (Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±) */
      --secondary-color: #f0f4f8; /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø±ÙˆØ´Ù† Ø¨Ú©Ú¯Ø±Ø§Ù†Ø¯ Ø§ØµÙ„ÛŒ */
      --accent-color: #007bff; /* Ø¢Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ£Ú©ÛŒØ¯ Ùˆ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† */
      --success-color: #28a745; 
      --danger-color: #dc3545; 
      --card-bg: white;
      --border-radius-lg: 18px;
      --border-radius-md: 10px;
    }
    
    body {
      direction: rtl;
      margin: 0;
      font-family: "Vazirmatn", sans-serif;
      line-height: 1.6;
      background: var(--secondary-color);
    }

    /* --- Ø·Ø±Ø­â€ŒØ¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Flexbox) --- */
    .dashboard-wrapper {
      display: flex; 
      min-height: 100vh;
      background: var(--secondary-color);
    }

    /* --- 1. Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± (Ù…Ù†ÙˆÛŒ Ú©Ù†Ø§Ø±ÛŒ) --- */
    .sidebar {
      width: 260px; 
      background: var(--primary-color); 
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.15);
      flex-shrink: 0; 
      padding: 25px 0;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      height: 100vh;
      box-sizing: border-box;
    }

    .sidebar-header {
      color: white;
      text-align: center;
      margin-bottom: 40px;
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-header .material-icons-outlined {
      margin-left: 10px;
      color: var(--accent-color);
      font-size: 28px;
    }

    .sidebar-nav {
      flex-grow: 1; 
    }

    .sidebar-nav a {
      display: flex;
      align-items: center;
      color: #c9d0d9; 
      padding: 15px 25px;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.3s, color 0.3s;
      cursor: pointer;
    }

    .sidebar-nav a:hover,
    .sidebar-nav a.active {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border-right: 4px solid var(--accent-color); 
    }

    .sidebar-nav a .material-icons-outlined {
      margin-left: 10px;
      font-size: 20px;
    }
    
    /* --- 2. Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ --- */
    .main-content {
      flex-grow: 1;
      padding: 40px;
      overflow-y: auto;
    }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ (container-panel) */
    .container-panel {
      max-width: 900px; 
      width: 100%;
      margin: 0 auto; 
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--border-radius-lg);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
    }

    /* --- Content Section Toggle --- */
    .content-section {
        display: none; /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù…Ù‡ Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§ */
    }
    .content-section.active {
        display: block; /* Ù†Ù…Ø§ÛŒØ´ Ø³Ú©Ø´Ù† ÙØ¹Ø§Ù„ */
    }
    
    /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ú©Ø§Ø±Øª --- */

    h2 {
      color: var(--primary-color);
      margin-bottom: 25px;
      text-align: center;
      font-weight: 700;
      font-size: 28px;
    }

    h3 {
      display: flex;
      align-items: center;
      color: var(--primary-color);
      margin-top: 35px;
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 22px;
    }

    h3 .material-icons-outlined {
      margin-left: 8px;
      color: var(--accent-color);
      font-size: 26px;
    }

    .pending-msg {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff3cd; 
      border: 1px solid #ffeeba;
      padding: 18px;
      border-radius: var(--border-radius-md);
      font-size: 16px;
      color: #856404; 
      margin-bottom: 30px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(255, 230, 0, 0.1);
    }

    .pending-msg .material-icons-outlined {
      margin-left: 10px;
      font-size: 24px;
    }

    .profile-box {
      padding: 30px;
      border-radius: var(--border-radius-md);
      background: #fcfcfc;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      margin-bottom: 30px;
      border: 1px solid #eef1f4;
    }

    .profile-box label {
      display: block;
      margin-top: 18px;
      margin-bottom: 8px;
      color: #4a5568; 
      font-weight: 500;
      font-size: 15px;
    }

    .profile-box input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #d4d8de;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
      background-color: white;
    }

    .profile-box input:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      outline: none;
    }

    .profile-box input[disabled] {
      background-color: #f5f5f5;
      color: #888;
      cursor: not-allowed;
    }

    /* --- Button Styles --- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s, box-shadow 0.3s;
      border: none;
      margin-top: 25px;
      line-height: 1; 
    }

    .btn .material-icons-outlined {
      font-size: 20px;
      margin-left: 8px;
    }

    .btn-primary {
      background: var(--accent-color);
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
    }

    /* --- Table Styles --- */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      border-radius: var(--border-radius-md);
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.07);
      background: white;
    }

    th, td {
      padding: 15px 18px;
      text-align: right;
      font-size: 15px;
    }

    th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f7f9fb;
    }

    tr:hover {
      background-color: #e9ecef;
      transition: background-color 0.2s;
    }
    
    .borrow-returned {
      color: var(--success-color);
      font-weight: 500;
    }
    .borrow-pending {
      color: var(--danger-color);
      font-weight: 500;
    }

    /* --- Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ (Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„) --- */
    @media (max-width: 900px) {
      .dashboard-wrapper {
        flex-direction: column; 
      }
      .sidebar {
        width: 100%; 
        height: auto;
        position: static;
        padding: 15px 0;
      }
      .sidebar-nav {
        display: flex;
        flex-wrap: wrap; 
        justify-content: space-around;
      }
      .sidebar-header {
        display: none; 
      }
      .sidebar-nav a {
        padding: 12px 10px;
        flex-direction: column; 
        flex-basis: 45%; /* Ú©Ù…ÛŒ ÙØ¶Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù„ÛŒÙ†Ú© */
        text-align: center;
        border-right: none !important;
      }
      .sidebar-nav a .material-icons-outlined {
        margin: 0 0 5px 0;
      }
      .main-content {
        padding: 20px;
      }
      .container-panel {
        padding: 20px;
      }
    }
  </style>
</head>

<body>

<div class="dashboard-wrapper">
  
  <nav class="sidebar">
    <div class="sidebar-header">
      <span class="material-icons-outlined">library_books</span>
      Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ù†
    </div>
    
    <div class="sidebar-nav">
      <a id="nav-dashboard" onclick="switchSection('dashboard', this)" class="active">
        <span class="material-icons-outlined">dashboard</span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
      </a>
      
      <a id="nav-settings" onclick="switchSection('settings', this)">
        <span class="material-icons-outlined">settings</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      </a>
      
      <div style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; margin-top: 50px;">
        <a href="index.html"><span class="material-icons-outlined">home</span> ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
        <a href="#" onclick="logout()" style="color: #ff6b6b;"><span class="material-icons-outlined">logout</span> Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="container-panel">
      
      <div id="pendingMsg" class="pending-msg" style="display:none;">
        <span class="material-icons-outlined">access_time</span>
        Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØµØ¨ÙˆØ± Ø¨Ø§Ø´ÛŒØ¯.
      </div>

      <div id="dashboard" class="content-section active">
        <h2><span class="material-icons-outlined" style="font-size: 32px; margin-left: 10px;">menu_book</span> Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</h2>

        <h3><span class="material-icons-outlined">history</span> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</h3>

        <table>
          <thead>
            <tr>
              <th>Ú©ØªØ§Ø¨</th>
              <th>ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª</th>
              <th>ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ú¯Ø´Øª</th>
              <th>ÙˆØ¶Ø¹ÛŒØª</th>
            </tr>
          </thead>
          <tbody id="borrowTable">
            <tr><td colspan="4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
          </tbody>
        </table>
        
      </div>
      
      <div id="settings" class="content-section">
        <h2><span class="material-icons-outlined" style="font-size: 32px; margin-left: 10px;">settings</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h2>
        
        <div class="profile-box">
          <h3><span class="material-icons-outlined">person</span> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h3>

          <label for="nameField">Ù†Ø§Ù… Ú©Ø§Ù…Ù„:</label>
          <input id="nameField" type="text" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">

          <label for="emailField">Ù¾Ø³Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ© (Ø§ÛŒÙ…ÛŒÙ„):</label>
          <input id="emailField" type="text" disabled placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§">

          <label for="passwordField">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ (Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±):</label>
          <input id="passwordField" type="password" placeholder="Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŒ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯">

          <label for="expireField">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¹Ø¶ÙˆÛŒØª:</label>
          <input id="expireField" type="text" disabled value="1404/01/01 (Ù†Ù…ÙˆÙ†Ù‡)">

          <button onclick="updateProfile()" class="btn btn-primary">
            <span class="material-icons-outlined">save</span>
            Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
const API = "http://localhost:3000";
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "{}");

// ØªØ¹Ø±ÛŒÙ Ø¹Ù†Ø§ØµØ± HTML Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¢Ø³Ø§Ù†â€ŒØªØ±
const pendingMsg = document.getElementById("pendingMsg");
const nameField = document.getElementById("nameField");
const emailField = document.getElementById("emailField");
const passwordField = document.getElementById("passwordField");

// Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ÙˆØ¶Ø¹ÛŒØª ÙˆØ±ÙˆØ¯
if (!token || !user) location.href = "index.html";
if (user.role === "admin") location.href = "admin-panel.html";

// Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
if (user.role === "pending") {
  pendingMsg.style.display = "flex"; 
}

// Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
nameField.value = user.name;
emailField.value = user.email;

/* --- Ù…Ù†Ø·Ù‚ ØªØºÛŒÛŒØ± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙˆØ§ --- */
function switchSection(sectionId, element) {
    // Ø­Ø°Ù Ú©Ù„Ø§Ø³ active Ø§Ø² Ù‡Ù…Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ
    document.querySelectorAll('.sidebar-nav a').forEach(link => {
        link.classList.remove('active');
    });
    // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„Ø§Ø³ active Ø¨Ù‡ Ù„ÛŒÙ†Ú© Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡
    element.classList.add('active');

    // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    // Ù†Ù…Ø§ÛŒØ´ Ø³Ú©Ø´Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
    document.getElementById(sectionId).classList.add('active');
}


/* ğŸ” Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± */
async function loadMyBorrows() {
  const tbody = document.getElementById("borrowTable");

  try {
    const res = await fetch(`${API}/api/my-borrows`, {
      headers: { Authorization: "Bearer " + token }
    });

    const data = await res.json();

    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #777;">Ø´Ù…Ø§ ØªØ§Ú©Ù†ÙˆÙ† Ø§Ù…Ø§Ù†ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map(b => {
      const isReturned = !!b.return_date;
      const statusClass = isReturned ? "borrow-returned" : "borrow-pending";
      const statusText = isReturned ? "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡" : "Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ø²Ú¯Ø´Øª";
      const returnDateDisplay = b.return_date ? new Date(b.return_date).toLocaleDateString("fa-IR") : "â€”";

      return `
        <tr>
          <td>${b.title}</td>
          <td>${new Date(b.borrow_date).toLocaleDateString("fa-IR")}</td>
          <td>${returnDateDisplay}</td>
          <td class="${statusClass}">${statusText}</td>
        </tr>
      `;
    }).join("");

  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--danger-color);">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</td></tr>`;
  }
}

async function updateProfile() {
  const newName = nameField.value.trim();
  const newPassword = passwordField.value.trim();

  if (!newName) return alert("Ù†Ø§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯");

  try {
    const res = await fetch(`${API}/api/profile`, {
      method: "PUT",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ name: newName, password: newPassword || undefined })
    });

    if (!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ");

    user.name = newName;
    localStorage.setItem("user", JSON.stringify(user));
    passwordField.value = ""; 
    alert("ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!");

  } catch (e) {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„: " + e.message);
  }
}

function logout() {
  localStorage.clear();
  location.href = "index.html";
}

loadMyBorrows();
</script>

</body>
</html>